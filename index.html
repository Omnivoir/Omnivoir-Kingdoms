<!DOCTYPE html>
<html>
<head>
  <title>Omnivoir: Kingdoms – Core Castle Render</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <style>
    html, body, #map { margin:0; padding:0; height:100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    // --- Map Setup ---
    const map = L.map('map').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'© OpenStreetMap', maxZoom:18
    }).addTo(map);

    // --- Assets (place in /assets/castles/) ---
    const ASSETS = {
      large:  './assets/castles/large_castle.png',
      medium: './assets/castles/medium_castle.png'
    };

    // meters→degrees (approx)
    const m2deg = m => m / 111000;

    // place 500m×500m castle overlay
    function placeCastle(lat, lon, type) {
      const half = m2deg(500/2);
      const bounds = [
        [lat - half, lon - half],
        [lat + half, lon + half]
      ];
      L.imageOverlay(ASSETS[type], bounds).addTo(map);
    }

    // fetch national & state capitals via Overpass
    async function loadCastles() {
      const bbox = '24.396308,-125.0,49.384358,-66.93457';
      const query = \`
        [out:json][timeout:25];
        (
          node["capital"~"national|state"](${bbox});
        );
        out body;
      \`;
      let data;
      try {
        const res = await fetch('https://overpass-api.de/api/interpreter', {
          method:'POST',
          body:'data='+encodeURIComponent(query)
        });
        data = await res.json();
      } catch(e) {
        console.error('Overpass error:', e);
        data = { elements: [] };
      }

      // Render all fetched capitals
      data.elements.forEach(el => {
        if(el.type==='node' && el.lat && el.lon) {
          const isNational = el.tags.capital==='national';
          const type = isNational ? 'large' : 'medium';
          placeCastle(el.lat, el.lon, type);
        }
      });

      // Ensure Washington D.C. (if missing) & Los Angeles
      // Washington, D.C.
      placeCastle(38.8951, -77.0364, 'large');
      // Los Angeles
      placeCastle(34.0522, -118.2437, 'large');
    }

    document.addEventListener('DOMContentLoaded', loadCastles);
  </script>
</body>
</html>
