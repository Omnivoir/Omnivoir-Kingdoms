<!DOCTYPE html>
<html>
<head>
  <title>Omnivoir: Kingdoms – Core Castle Render</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <style>html,body,#map{margin:0;padding:0;height:100%;}</style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    // Initialize map centered on USA
    const map = L.map('map').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap', maxZoom:18
    }).addTo(map);

    // Assets for castles (ensure these files are in /assets/castles/)
    const assets = {
      large:  './assets/castles/large_castle.png',
      medium: './assets/castles/medium_castle.png'
    };

    // Helper: convert meters to degrees approx.
    const m2deg = m => m / 111000;

    // Place a 500m x 500m castle overlay
    function placeCastle(lat, lon, type) {
      const half = m2deg(500 / 2);
      const bounds = [
        [lat - half, lon - half],
        [lat + half, lon + half]
      ];
      L.imageOverlay(assets[type], bounds).addTo(map);
    }

    // Fetch the US national capital, state capitals, and Los Angeles
    async function loadCastles() {
      const bbox = '24.396308,-125.0,49.384358,-66.93457';
      const query = `
        [out:json][timeout:25];
        (
          node["capital"="national"](${bbox});
          node["capital"="state"](${bbox});
          node["name"="Los Angeles"](${bbox});
        );
        out body;
      `;
      const response = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        body: 'data=' + encodeURIComponent(query)
      });
      const data = await response.json();
      data.elements.forEach(el => {
        if (el.type === 'node' && el.lat && el.lon) {
          // Determine castle type
          const type = (el.tags.capital === 'national' || el.tags.name === 'Los Angeles')
                       ? 'large' : 'medium';
          placeCastle(el.lat, el.lon, type);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', loadCastles);
  </script>
</body>
</html>
